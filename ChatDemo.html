<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/amazon-connect-streams@2.18.3/release/connect-streams.js"></script>
    <script type="text/javascript" src="amazon-connect-chat-interface.js"></script>
    <style>
        body { background: #fafafa; }
        
        /* Column 1: Participants */
        .participants-column {
            border-right: 1px solid #dbdbdb;
            background: white;
            height: 100vh;
            overflow-y: auto;
        }
        
        .participants-header {
            padding: 20px;
            border-bottom: 1px solid #dbdbdb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .auth-buttons {
            display: flex;
            gap: 8px;
        }
        
        .auth-buttons .btn {
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .participant-item {
            padding: 12px 20px;
            border-bottom: 1px solid #efefef;
            cursor: pointer;
        }
        
        .participant-item:hover {
            background: #f5f5f5;
        }
        
        .participant-item.active {
            background: #e3f2fd;
            border-left: 3px solid #0095f6;
        }
        
        .participant-item.new-incoming {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            animation: pulse 2s infinite;
        }
        
        .participant-item.new-incoming .fw-bold {
            color: #856404;
        }
        
        @keyframes pulse {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeaa7; }
            100% { background-color: #fff3cd; }
        }
        
        /* Column 2: Chat */
        .chat-column {
            border-right: 1px solid #dbdbdb;
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #dbdbdb;
            background: white;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }
        
        .chat-input {
            padding: 20px;
            border-top: 1px solid #dbdbdb;
            background: white;
        }
        
        .message-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #dbdbdb;
            border-radius: 22px;
            padding: 8px 16px;
        }
        
        .message-input-group input {
            border: none;
            outline: none;
            flex: 1;
        }
        
        .input-actions {
            display: flex;
            gap: 8px;
        }
        
        .input-actions button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }
        
        /* Column 3: Participant Info */
        .info-column {
            background: white;
            height: 100vh;
            overflow-y: auto;
        }
        
        .info-header {
            padding: 20px;
            border-bottom: 1px solid #dbdbdb;
            text-align: center;
        }
        
        .info-content {
            padding: 20px;
        }
        
        .info-item {
            margin-bottom: 16px;
        }
        
        .info-label {
            font-weight: 600;
            color: #8e8e8e;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .info-value {
            margin-top: 4px;
            font-size: 14px;
        }
        
        /* Chat messages */
        .chat-message {
            margin-bottom: 16px;
        }
        
        .message-sent {
            text-align: right;
        }
        
        .message-received {
            text-align: left;
        }
        
        .message-bubble {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .message-sent .message-bubble {
            background: #0095f6;
            color: white;
        }
        
        .message-received .message-bubble {
            background: #efefef;
            color: black;
        }
        
        /* CCP Container */
        #container-div {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Column 1: Chat Participants -->
            <div class="col-3 p-0 participants-column">
                <div class="participants-header">
                    <h6 class="mb-0">聊天参与者</h6>
                    <div class="auth-buttons">
                        <button class="btn btn-outline-primary" onclick="init()">登录</button>
                        <button class="btn btn-outline-secondary" onclick="Logout()">退出</button>
                        <button class="btn btn-outline-info" id="ccpContainer-btn" onclick="showCCP()">显示CCP</button>
                        <button class="btn btn-outline-warning" id="logContainer-btn" onclick="showLog()">显示日志</button>
                    </div>
                </div>
                
                <!-- CCP Container -->
                <div id="container-div" style="width: 100%; height: 300px; display: none;"></div>
                
                <!-- Participants List -->
                <ul id="clist" class="list-unstyled mb-0"></ul>
                
                <!-- Log Container -->
                <div id="logContainer" style="display: none; border-top: 1px solid #dbdbdb; padding: 10px; background: #f8f9fa;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">系统日志</small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearOutput()">清除</button>
                    </div>
                    <textarea id="logDisplay" readonly style="width: 100%; height: 200px; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; padding: 8px; resize: none;"></textarea>
                </div>
            </div>
            
            <!-- Column 2: Chat Messages -->
            <div class="col-6 p-0 chat-column">
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">聊天消息</h6>
                        <select id="stateDropdown" class="form-select form-select-sm" style="width: auto;" onchange="handleSelectChange()"></select>
                    </div>
                </div>
                
                <div class="chat-messages" id="txtChatBox">
                    <!-- Messages will be displayed here -->
                </div>
                
                <div class="chat-input">
                    <div class="message-input-group">
                        <div class="input-actions">
                            <button title="附件">📎</button>
                            <button title="表情">😊</button>
                        </div>
                        <input type="text" placeholder="输入消息..." id="txtMessage" onkeypress="if(event.key==='Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" style="background: #0095f6; color: white; border: none; border-radius: 4px; padding: 6px 12px;">发送</button>
                    </div>
                    <div class="mt-2">
                        <div class="input-group input-group-sm">
                            <select id="myDropdown" class="form-select"></select>
                            <button class="btn btn-outline-primary" onclick="TransferChat()">转接</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Column 3: Participant Info -->
            <div class="col-3 p-0 info-column">
                <div class="info-header">
                    <h6 class="mb-0">参与者信息</h6>
                </div>
                
                <!-- Agent Login Info -->
                <div id="agentInfo" style="padding: 15px; border-bottom: 1px solid #dbdbdb; background: #f8f9fa; display: none;">
                    <div class="info-item">
                        <div class="info-label">登录用户</div>
                        <div class="info-value" id="agentName">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">登录时间</div>
                        <div class="info-value" id="loginTime">-</div>
                    </div>
                </div>
                
                <div class="info-content" id="participantInfo">
                    <div class="info-item">
                        <div class="info-label">姓名</div>
                        <div class="info-value" id="participantName">未选择参与者</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">邮箱</div>
                        <div class="info-value" id="participantEmail">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">状态</div>
                        <div class="info-value" id="participantStatus">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">联系ID</div>
                        <div class="info-value" id="participantContactId">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden debug output -->
        <textarea id="message" style="display: none;"></textarea>

        <script type="text/javascript">
            const instanceURL = "https://connect-us-1.my.connect.aws/";
            const instanceCCPURL = instanceURL + "ccp-v2/";
            const instanceRegion = "us-east-1";
            const loginURL = "";
            const logoutURL = "https://connect-us-1.my.connect.aws/connect/logout";

            // initialize the streams api
            function init() {

                window.localStorage.removeItem('connectPopupManager::connect::loginPopup');

                initialize();

                // initialize the ccp
                initCore(instanceCCPURL, loginURL, instanceRegion);

                connect.contact(subscribeToContactEvents);

                connect.agent(subscribeToAgentEvents);

            }

            function initCore(instanceCCPURL, loginURL, instanceRegion) {
                var containerDiv = document.getElementById("container-div");
                try {
                    connect.core.initCCP(containerDiv, {
                        ccpUrl: instanceCCPURL,            // REQUIRED
                        loginUrl: loginURL,
                        loginPopup: true,               // optional, defaults to `true`
                        loginPopupAutoClose: true,      // optional, defaults to `false`
                        loginOptions: {                 // optional, if provided opens login in new window
                            autoClose: true,              // optional, defaults to `false`
                            height: 600,                  // optional, defaults to 578
                            width: 400,                   // optional, defaults to 433
                            top: 0,                       // optional, defaults to 0
                            left: 0                       // optional, defaults to 0
                        },
                        region: instanceRegion,         // REQUIRED for `CHAT`, optional otherwise
                        softphone: {                    // optional, defaults below apply if not provided
                            allowFramedSoftphone: true,   // optional, defaults to false
                            disableRingtone: false,       // optional, defaults to false
                            // ringtoneUrl: "./ringtone.mp3" // optional, defaults to CCP’s default ringtone if a falsy value is set
                        },
                        chat: {
                            disableRingtone: false, // optional, defaults to false
                            ringtoneUrl: "http://127.0.0.1:54093/agent-chat-demo-customized/ringtone.mp3"
                        },
                        pageOptions: { //optional
                            enableAudioDeviceSettings: true, //optional, defaults to 'false'
                            enablePhoneTypeSettings: true //optional, defaults to 'true'
                        },
                        ccpAckTimeout: 5000, //optional, defaults to 3000 (ms)
                        ccpSynTimeout: 3000, //optional, defaults to 1000 (ms)
                        ccpLoadTimeout: 10000 //optional, defaults to 5000 (ms)
                    });
                }
                catch (err) {
                    logOutput(JSON.stringify(err));
                }
            }

            function subscribeToContactEvents(c) {
                c.onConnecting((c) => {
                    logOutput('onConnecting event : handleContactConnecting');

                    window.contact = c;
                    addConnectingContact(c);
                });

                c.onConnected((c) => {
                    logOutput('onConnected event : Contact connected to agent');

                    window.contact = c;
                    addConnectedContact(c);

                    if (!window.controllers[c.contactId]) {
                        initChatController(c);
                    };
                });

                c.onAccepted(async () => {
                    initChatController(c);
                });

                c.onACW((c) => {
                    addConnectedContact(c);
                });

                c.onEnded((c) => {
                    logOutput('onEnded event');
                });

                c.onRefresh((c) => {
                    logOutput('onRefresh event');
                });

                c.onMissed((c) => {
                    logOutput('onMissed event');

                    addMissedContact(c);
                });

            }

            async function initChatController(contact) {
                const cnn = contact.getAgentConnection();
                if (cnn) {
                    const controller = await cnn.getMediaController();
                    window.controllers[contact.contactId] = controller;
                    
                    // Set as current if no current contact
                    if (!window.currentContactId) {
                        window.currentContactId = contact.contactId;
                        window.controller = controller;
                    }
                    
                    controller.onMessage(async function (response) {
                        logOutput("on message:" + JSON.stringify(response));
                        await addChatMessage(response, contact.contactId);
                    });

                    const awsSdkResponse = await controller.getTranscript({
                        maxResults: 100,
                        sortOrder: "ASCENDING"
                    });
                    const { InitialContactId, NextToken, Transcript } = awsSdkResponse.data;
                    await addChatTranscriptMessage(Transcript, contact.contactId);
                    logOutput(JSON.stringify(Transcript));

                    controller.onConnectionLost(function (response) {
                        logOutput("connection lost:" + JSON.stringify(response));
                    });
                }
            }

            function sendChatMessage() {
                if (window.controller) {
                    var msg = document.getElementById('txtMessage').value;
                    window.controller.sendMessage({
                        contentType: "text/plain",
                        message: msg
                    });
                    document.getElementById('txtMessage').value = '';
                    logOutput("send message:" + msg);
                }
            }

            function getReceivedMessage() {
                const table = '<div class="chat-message message-received">' +
                    '<div class="message-bubble">Content</div>' +
                    '<div class="text-muted small mt-1">DisplayName · Time</div>' +
                    '</div>'
                return table;
            }

            function getSentMessage() {
                const table = '<div class="chat-message message-sent">' +
                    '<div class="message-bubble">Content</div>' +
                    '<div class="text-muted small mt-1">Time</div>' +
                    '</div>'
                return table;
            }

            function getCurrentTime() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const currentTime = `${hours}:${minutes}:${seconds}`;
                return currentTime;
            }

            async function getChatMessage(response, role) {
                if (response.data) {
                    // Handle MESSAGE type
                    if (response.data.Type === 'MESSAGE') {
                        var table = role === 'sent' ? getSentMessage() : getReceivedMessage();
                        table = table.replace("DisplayName", response.data.DisplayName || 'Unknown');
                        table = table.replace("Content", response.data.Content || '');
                        table = table.replace("Time", getCurrentTime());

                        return table;
                    }

                    // Handle ATTACHMENT type
                    if (response.data.Type === 'ATTACHMENT' && response.data.Attachments && response.data.Attachments.length > 0) {
                        var table = role === 'sent' ? getSentMessage() : getReceivedMessage();
                        table = table.replace("DisplayName", response.data.DisplayName || 'Unknown');

                        // Create attachment links
                        var content = '';

                        for (const attachment of response.data.Attachments) {
                            // Create a hyperlink for each attachment
                            var attachmentContent = '';

                            const awsSdkResponse = await window.controller.downloadAttachment({
                                attachmentId: attachment.AttachmentId
                            });
                            var attachmentUrl = URL.createObjectURL(awsSdkResponse);

                            if (attachment.ContentType == "image/png") {
                                var attachmentImg = '<img src="' +
                                    attachmentUrl + '" style="max-width: 100%; height: auto;"></img>';
                                attachmentContent += attachmentImg;
                            }

                            var attachmentLink = '<a href="' +
                                attachmentUrl + '" download="' +
                                attachment.AttachmentName + '" >' +
                                attachment.AttachmentName + '</a>';
                            attachmentContent += attachmentLink;

                            content += '<div class="attachment-item">' + attachmentContent + '</div>';
                        }

                        table = table.replace("Content", content || '');
                        table = table.replace("Time", getCurrentTime());

                        return table;
                    }
                }

                return '';
            }

            async function addChatMessage(response, contactId = null) {
                var message = await getChatMessage(response, response.data.ParticipantRole == 'AGENT' ? 'sent' : 'received');
                const targetContactId = contactId || window.currentContactId;
                
                if (targetContactId) {
                    // Store message for this contact
                    if (!window.chatMessages[targetContactId]) {
                        window.chatMessages[targetContactId] = '';
                    }
                    window.chatMessages[targetContactId] += message;
                    
                    // Only update display if this is the current contact
                    if (targetContactId === window.currentContactId) {
                        document.getElementById('txtChatBox').innerHTML = window.chatMessages[targetContactId];
                        document.getElementById('txtChatBox').scrollTop = document.getElementById('txtChatBox').scrollHeight;
                    }
                }
            }

            async function addChatTranscriptMessage(response, contactId) {
                let messages = '';
                for (const item of response) {
                    const type = item.Type;
                    if (type == 'MESSAGE') {
                        const participantRole = item.ParticipantRole;
                        const displayName = item.DisplayName;
                        const content = item.Content;
                        const localTime = convertToLocalTime(item.AbsoluteTime);

                        var table = participantRole == 'CUSTOMER' ? getReceivedMessage() : getSentMessage();
                        table = table.replace("DisplayName", displayName);
                        table = table.replace("Content", content);
                        table = table.replace("Time", localTime);

                        messages += table;
                    }
                    if (type == 'ATTACHMENT') {
                        const participantRole = item.ParticipantRole;
                        const displayName = item.DisplayName;
                        const localTime = convertToLocalTime(item.AbsoluteTime);

                        var table = participantRole == 'CUSTOMER' ? getReceivedMessage() : getSentMessage();
                        table = table.replace("DisplayName", displayName);

                        var content = "";
                        for (const attachment of item.Attachments) {
                            // Create a hyperlink for each attachment
                            var attachmentContent = '';

                            const awsSdkResponse = await window.controller.downloadAttachment({
                                attachmentId: attachment.AttachmentId
                            });
                            var attachmentUrl = URL.createObjectURL(awsSdkResponse);

                            if (attachment.ContentType == "image/png") {
                                var attachmentImg = '<img src="' +
                                    attachmentUrl + '" style="max-width: 100%; height: auto;"></img>';
                                attachmentContent += attachmentImg;
                            }

                            var attachmentLink = '<a href="' +
                                attachmentUrl + '" download="' +
                                attachment.AttachmentName + '" >' +
                                attachment.AttachmentName + '</a>';
                            attachmentContent += attachmentLink;

                            content += '<div class="attachment-item">' + attachmentContent + '</div>';
                        }

                        table = table.replace("Content", content);
                        table = table.replace("Time", localTime);

                        messages += table;
                    }
                }
                
                // Store messages for this contact
                window.chatMessages[contactId] = messages;
                
                // Only update display if this is the current contact
                if (contactId === window.currentContactId) {
                    document.getElementById('txtChatBox').innerHTML = messages;
                    document.getElementById('txtChatBox').scrollTop = document.getElementById('txtChatBox').scrollHeight;
                }
            }

            function convertToLocalTime(utcTimeString) {
                const date = new Date(utcTimeString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }

            function removeContact(contactId) {
                const list = document.getElementById('clist');
                const item = document.getElementById(contactId);
                if (item) {
                    list.removeChild(item);
                }
            }

            function addConnectingContact(contact) {
                removeContact(contact.contactId);

                const participantItem = document.createElement('li');
                participantItem.id = contact.contactId;
                participantItem.className = 'participant-item new-incoming';
                participantItem.onclick = () => selectParticipant(contact);
                
                participantItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${getCustomerName(contact)}</div>
                            <div class="text-muted small" id="${contact.contactId}-indicator">连接中...</div>
                        </div>
                        <div>
                            <button class="btn btn-success btn-sm me-1" onclick="AcceptContact()">接受</button>
                            <button class="btn btn-danger btn-sm" onclick="RejectContact()">拒绝</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('clist').appendChild(participantItem);
                restart_checker(contact.contactId, true, '连接中');
            }

            function addConnectedContact(contact) {
                removeContact(contact.contactId);

                const participantItem = document.createElement('li');
                participantItem.id = contact.contactId;
                participantItem.className = 'participant-item';
                participantItem.onclick = () => selectParticipant(contact);
                
                participantItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${getCustomerName(contact)}</div>
                            <div class="text-success small" id="${contact.contactId}-indicator">已连接</div>
                        </div>
                        <div>
                            <button class="btn btn-outline-danger btn-sm me-1" onclick="EndContact('${contact.contactId}')">结束</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="ClearContact('${contact.contactId}')">清除</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('clist').appendChild(participantItem);
                restart_checker(contact.contactId, true, '已连接');
                
                // Auto-select if no current contact
                if (!window.currentContactId) {
                    selectParticipant(contact);
                }
            }

            function addMissedContact(contact) {
                removeContact(contact.contactId);

                const participantItem = document.createElement('li');
                participantItem.id = contact.contactId;
                participantItem.className = 'participant-item';
                participantItem.onclick = () => selectParticipant(contact);
                
                participantItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">聊天</div>
                            <div class="text-warning small" id="${contact.contactId}-indicator">未接</div>
                        </div>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm" onclick="ClearContact('${contact.contactId}')">清除</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('clist').appendChild(participantItem);
                restart_checker(contact.contactId, true, '未接');
            }
            
            function selectParticipant(contact) {
                // Remove active class from all participants
                document.querySelectorAll('.participant-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const participantElement = document.getElementById(contact.contactId);
                if (participantElement) {
                    // Remove new-incoming highlight when selected
                    participantElement.classList.remove('new-incoming');
                    // Add active class to selected participant
                    participantElement.classList.add('active');
                }
                
                // Update current contact and controller
                window.currentContactId = contact.contactId;
                window.contact = contact;
                window.controller = window.controllers[contact.contactId];
                
                // Update participant info
                document.getElementById('participantName').textContent = getCustomerName(contact);
                document.getElementById('participantContactId').textContent = contact.contactId;
                document.getElementById('participantStatus').textContent = contact.getState().type;
                document.getElementById('participantEmail').textContent = getCustomerEmail(contact) || '-';
                
                // Load chat messages for this contact
                loadChatMessages(contact.contactId);
            }
            
            function loadChatMessages(contactId) {
                const chatBox = document.getElementById('txtChatBox');
                chatBox.innerHTML = window.chatMessages[contactId] || '';
                chatBox.scrollTop = chatBox.scrollHeight;
            }
            
            function getCustomerEmail(contact) {
                try {
                    var c1 = contact.getConnections()[1];
                    var info = c1.getMediaInfo().originalInfo;
                    return info ? info.customerEmail : null;
                } catch (e) {
                    return null;
                }
            }
            
            function showCCP() {
                const ccpDiv = document.getElementById('container-div');
                if (ccpDiv.style.display === 'none') {
                    ccpDiv.style.display = 'block';
                } else {
                    ccpDiv.style.display = 'none';
                }
                ccpDiv.style.height = ccpDiv.style.display=='block' ? "625px" : "100%";
                
                var containerBtn = document.getElementById('ccpContainer-btn');
                containerBtn.textContent = ccpDiv.style.display=='block' ? "隐藏CCP" : "显示CCP";
            }

            function subscribeToAgentEvents(agent) {
                logOutput('Agent login');
                
                // Show agent login info
                showAgentLoginInfo(agent);

                agent.onStateChange((event) => {
                    showAgentStatus('onStateChange', agent);
                });

                agent.onOffline((event) => {
                    showAgentStatus('onOffline', agent);
                    hideAgentLoginInfo();
                });

                agent.onRefresh((event) => {
                    logOutput('Agent onRefresh');
                });

                agent.onRoutable((event) => {
                    logOutput('Agent onRoutable');
                });

                agent.onNotRoutable((event) => {
                    logOutput('Agent onNotRoutable');
                });

                agent.onSoftphoneError((event) => {
                    logOutput('Agent onSoftphoneError');
                });

                agent.onWebSocketConnectionLost((event) => {
                    logOutput('Agent onWebSocketConnectionLost');
                });

                agent.onWebSocketConnectionGained((event) => {
                    logOutput('Agent onWebSocketConnectionGained');
                });

                agent.onAfterCallWork((event) => {
                    logOutput('Agent onAfterCallWork');
                });

                loadAgentStates();

                loadQuickConnects();

                loadMissedContact();
            }

            function loadMissedContact() {
                var isMissed = false;

                const agent = new lily.Agent();
                const contacts = agent.getContacts();
                const contact = contacts.filter(c => c.getState().type === 'error')[0];
                if (contact) {
                    isMissed = true;
                }

                if (isMissed) {
                    addMissedContact(contact);
                }
            }

            function getCustomerName(contact) {
                var name = "Anonymous";
                var c1 = contact.getConnections()[1];
                var info = c1.getMediaInfo().originalInfo;
                if (info) {
                    name = info.customerName;
                }
                return name;
            }



            function showAgentStatus(trigger, agent) {
                var aname = agent.getName();
                var astate = agent.getState();
                logOutput(trigger + ' event : ' + aname + ' goes ' + astate.name);
            }

            function initialize() {
                window.contact = window.contact || {};
                window.controller = window.controller || {};
                window.timers = {};
                window.controllers = {};
                window.endpoints = [];
                window.chatMessages = {};
                window.currentContactId = null;
            }

            function logOutput(text) {
                var textarea = document.getElementById("message");
                textarea.value += text + "\n";
                
                // Also update the visible log display if it's shown
                var logDisplay = document.getElementById("logDisplay");
                if (logDisplay) {
                    logDisplay.value = textarea.value;
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                }
            }

            function clearOutput() {
                document.getElementById('message').value = "";
                var logDisplay = document.getElementById("logDisplay");
                if (logDisplay) {
                    logDisplay.value = "";
                }
            }
            
            function showLog() {
                const logContainer = document.getElementById('logContainer');
                const logBtn = document.getElementById('logContainer-btn');
                const logDisplay = document.getElementById('logDisplay');
                
                if (logContainer.style.display === 'none') {
                    logContainer.style.display = 'block';
                    logBtn.textContent = '隐藏日志';
                    // Sync log content
                    logDisplay.value = document.getElementById('message').value;
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                } else {
                    logContainer.style.display = 'none';
                    logBtn.textContent = '显示日志';
                }
            }
            
            function showAgentLoginInfo(agent) {
                const agentInfo = document.getElementById('agentInfo');
                const agentName = document.getElementById('agentName');
                const loginTime = document.getElementById('loginTime');
                
                agentName.textContent = agent.getName() || '未知用户';
                loginTime.textContent = new Date().toLocaleString('zh-CN');
                agentInfo.style.display = 'block';
                
                logOutput('用户登录: ' + agentName.textContent + ' 于 ' + loginTime.textContent);
            }
            
            function hideAgentLoginInfo() {
                const agentInfo = document.getElementById('agentInfo');
                agentInfo.style.display = 'none';
                logOutput('用户已退出登录');
            }

            function AcceptContact() {
                if (window.contact == {}) {
                    alert("No contact is coming");
                }
                else {
                    c = window.contact;
                    c.accept({
                        success: function () {
                            // Remove new-incoming highlight after accepting
                            const participantElement = document.getElementById(c.contactId);
                            if (participantElement) {
                                participantElement.classList.remove('new-incoming');
                            }
                        },
                        failure: function (err) {
                        }
                    });
                }
            }

            function RejectContact() {
                if (window.contact == {}) {
                    alert("No contact is coming");
                }
                else {
                    c = window.contact;
                    c.reject({
                        success: function () {
                            // Remove participant from list after rejecting
                            removeContact(c.contactId);
                        },
                        failure: function (err) {
                        }
                    });
                }
            }

            function EndContact(contactId) {
                c = getContact(contactId);
                if (!c) {
                    alert("No call is connected");
                }
                else {
                    var initialConnection = c.getInitialConnection();
                    var thirdParty = c.getSingleActiveThirdPartyConnection();
                    if (initialConnection) {
                        initialConnection.destroy({
                            success: function () {
                            },
                            failure: function (err) {
                                alert(err)
                            }
                        });
                    }
                }

                restart_checker(c.contactId, true, 'ACW');
            }

            function restart_checker(cId, display, s) {
                const checkTimer = window.timers[cId];
                if (checkTimer) {
                    clearInterval(checkTimer);
                }

                if (display) {
                    const startTime = new Date().getTime();
                    window.timers[cId] = setInterval(() => {
                        const currentTime = new Date().getTime();
                        const elapsedTime = currentTime - startTime;
                        const durationString = formatTime(elapsedTime);

                        const indicator = cId + '-indicator';
                        var timerDiv = document.getElementById(indicator);
                        timerDiv.textContent = ' ' + s + ' ' + durationString;
                    }, 1000);
                }
            }

            function formatTime(milliseconds) {
                const seconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);

                const remainingSeconds = seconds % 60;
                const remainingMinutes = minutes % 60;

                return `${padZero(hours)}:${padZero(remainingMinutes)}:${padZero(remainingSeconds)}`;
            }

            function padZero(value) {
                return value.toString().padStart(2, '0');
            }



            function SetAgentState(stateName) {
                const agent = new lily.Agent();
                const states = agent.getAgentStates();
                if (states.length > 0) {
                    const state = states.filter(s => s.name === stateName)[0];
                    agent.setState(state, {
                        success: function () {
                        },
                        failure: function () {
                        }
                    });
                }
            }




            function clearChatWindow(contactId = null) {
                const targetContactId = contactId || window.currentContactId;
                if (targetContactId) {
                    delete window.chatMessages[targetContactId];
                    if (targetContactId === window.currentContactId) {
                        document.getElementById('txtChatBox').innerHTML = '';
                    }
                }
                document.getElementById('txtMessage').value = '';
            }

            function ClearContact(contactId) {
                c = getContact(contactId);
                if (!c) {
                    alert("No contact is coming");
                }
                else {
                    c.clear({
                        success: function () {
                            removeContact(contactId);
                            clearChatWindow(contactId);
                        },
                        failure: function (err) {

                        }
                    });
                }

                restart_checker(contactId, false, '');
            }

            function loadAgentStates() {
                const agent = new lily.Agent();
                const curState = agent.getState().name;
                const states = agent.getAgentStates();
                states.sort((a, b) => a.name.localeCompare(b.name));
                const dropdown = document.getElementById("stateDropdown");
                dropdown.options.length = 0;
                for (let i = 0; i < states.length; i++) {
                    // Create a new <option> element
                    const option = document.createElement("option");

                    // Set the value and text of the <option>
                    option.value = i;
                    option.text = states[i].name;
                    if (option.text == curState) {
                        option.selected = "selected";
                    }

                    // Add the <option> to the <select>
                    dropdown.add(option);
                };
            }

            function handleSelectChange() {
                const dropdown = document.getElementById("stateDropdown");
                const selectedOption = dropdown.options[dropdown.selectedIndex];
                const selectedState = selectedOption.text;
                SetAgentState(selectedState);
            }

            function loadQuickConnects() {
                var agent = new lily.Agent();
                var queuesARNs = agent.getAllQueueARNs();
                agent.getEndpoints(queuesARNs, {
                    success: function (data) {
                        window.endpoints = data.endpoints;
                        // Get a reference to the dropdown element
                        const dropdown = document.getElementById("myDropdown");
                        dropdown.options.length = 0;
                        // Loop through the options array
                        for (let i = 0; i < data.endpoints.length; i++) {
                            // Create a new <option> element
                            const option = document.createElement("option");

                            // Set the value and text of the <option>
                            option.value = i;
                            option.text = data.endpoints[i].name;

                            // Add the <option> to the <select>
                            dropdown.add(option);
                        };
                    },
                    failure: function (data) {
                        //alert("Supervisor is unavailable...");
                    }
                });
            }

            function getSelectedEndpoint() {
                // Get a reference to the dropdown element
                const dropdown = document.getElementById("myDropdown");
                // Get the selected option index
                const selectedIndex = dropdown.selectedIndex;

                // If an option is selected, get its value and text
                if (selectedIndex !== -1) {
                    const selectedValue = dropdown.options[selectedIndex].value;
                    return window.endpoints[selectedValue];
                } else {
                    return []
                }
            }

            function TransferChat() {
                const endpoint = getSelectedEndpoint();
                var agent = new lily.Agent();
                agent.getContacts(lily.ContactType.CHAT)[0].addConnection(endpoint, {
                    success: function (data) {
                    },
                    failure: function (data) {
                        alert("Error transfering chat");
                    }
                });
            }

            function getContact(contactId) {
                var contact = null
                const agent = new lily.Agent();
                const contacts = agent.getContacts();
                contacts.forEach(function (item) {
                    if (contactId == item.contactId) {
                        contact = item;
                        return;
                    }

                });
                return contact;
            }

            function Logout() {
                hideAgentLoginInfo();
                fetch(logoutURL, { credentials: 'include', mode: 'no-cors' })
                    .then(() => {
                        const eventBus = connect.core.getEventBus();
                        eventBus.trigger(connect.EventType.TERMINATE);

                        clearChatWindow();
                    }).then(() => {
                        window.location.reload();
                    });
            }
        </script>
</body>

</html>
